from django.test import TestCase, Client

import jsondiff
from deepdiff import DeepDiff
import json

STRATIGRAPHY_REFS = {
#'67d11e72-2574-11e6-a316-000c29148083':{"strata": [{"name": "67d11e72-2574-11e6-a316-000c29148083_Strata1", "characteristics": [{"visible": False, "order": 13, "name": "cpExtensionSi", "family": "cpCompositionExtensionFamily", "real_name": "Si"}, {"visible": False, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": True, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": True, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": False, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": False, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": True, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": False, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": True, "order": 10, "name": "darkGreenCharacteristic", "family": "colourFamily", "real_name": "dark green"}, {"visible": True, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": True, "order": 2, "name": "normalWidthCharacteristic", "family": "widthFamily", "real_name": "medium"}, {"visible": False, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": False, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": False, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": True, "order": 2, "name": "normalThicknessCharacteristic", "family": "thicknessFamily", "real_name": "medium"}, {"visible": False, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": False, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}], "interfaces": {"characteristics": [{"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}], "name": "67d11e72-2574-11e6-a316-000c29148083_Strata1_interface1"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "phase": "Solid", "version": 4, "date": "2018-02-09"}], "cpCompositionSecondaryElements": [{"category": "polyatomic nonmetal", "symbol": "S", "number": 16, "real_name": "Sulfur", "phase": "Solid", "version": 4, "date": "2018-02-09", "name": "S"}, {"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "phase": "Gas", "version": 4, "date": "2018-02-09", "name": "O"}, {"category": "diatomic nonmetal", "symbol": "H", "number": 1, "real_name": "Hydrogen", "phase": "Gas", "version": 4, "date": "2018-02-09", "name": "H"}], "cpCompositionAdditionalElements": [{"category": "metalloid", "name": "Si", "symbol": "Si", "number": 14, "real_name": "Silicon", "phase": "Solid", "version": 4, "date": "2018-02-09"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Brochantite (Cu4(OH)6SO4)", "version": 4, "name": "cpdBrochantite"}]}}, {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata2", "characteristics": [{"visible": False, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": True, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": True, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": False, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": False, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": True, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": False, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": True, "order": 6, "name": "darkRedCharacteristic", "family": "colourFamily", "real_name": "dark red"}, {"visible": True, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": True, "order": 2, "name": "normalWidthCharacteristic", "family": "widthFamily", "real_name": "medium"}, {"visible": False, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": False, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": False, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": True, "order": 3, "name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin"}, {"visible": False, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": False, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}], "name": "67d11e72-2574-11e6-a316-000c29148083_Strata2_interface2"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "phase": "Solid", "version": 4, "date": "2018-02-09"}], "cpCompositionSecondaryElements": [{"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "phase": "Gas", "version": 4, "date": "2018-02-09", "name": "O"}], "cpCompositionAdditionalElements": [{"category": "polyatomic nonmetal", "symbol": "S", "number": 16, "real_name": "Sulfur", "phase": "Solid", "version": 4, "date": "2018-02-09", "name": "S"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Cuprite (Cu2O)", "version": 4, "name": "cpdCuprite"}]}}, {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata3", "characteristics": [{"visible": True, "order": 3, "name": "grainLargeCharacteristic", "family": "mMicrostructureFamily", "real_name": "large grain"}, {"visible": True, "order": 3, "name": "noCracksCharacteristic", "family": "crackingFamily", "real_name": "no crack"}, {"visible": False, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": False, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": True, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": False, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": True, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": True, "order": 2, "name": "normalWidthCharacteristic", "family": "widthFamily", "real_name": "medium"}, {"visible": False, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": False, "order": 1, "name": "metallicCharacteristic", "family": "brightnessFamily", "real_name": "metallic"}, {"visible": False, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": True, "order": 1, "name": "thickCharacteristic", "family": "thicknessFamily", "real_name": "thick"}, {"visible": False, "order": 16, "name": "parallelepipedalCharacteristic", "family": "shapeFamily", "real_name": "parallelepipedal"}, {"visible": True, "order": 7, "name": "pinkCharacteristic", "family": "colourFamily", "real_name": "pink"}, {"visible": False, "order": 4, "name": "mCharacteristic", "family": "natureFamily", "real_name": "Metal"}], "interfaces": {"characteristics": [{"name": "looselyCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}], "name": "67d11e72-2574-11e6-a316-000c29148083_Strata3_interface3"}, "subcharacteristics": [{"name": "inclusionsGrainLarge", "real_name": "inclusions"}, {"name": "twinLinesGrainLarge", "real_name": "twin lines / Newmann bands"}], "children": [], "containers": {"mCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "phase": "Solid", "version": 4, "date": "2018-02-09"}]}}], "uid": "67d11e72-2574-11e6-a316-000c29148083", "description": "Shingle of a roof"},
'67d11e72-2574-11e6-a316-000c29148083':{"uid": "67d11e72-2574-11e6-a316-000c29148083", "description": "Shingle of a roof", "strata": [{"name": "67d11e72-2574-11e6-a316-000c29148083_Strata1", "characteristics": [{"name": "cpExtensionSi", "family": "cpCompositionExtensionFamily", "real_name": "Si", "order": 13, "visible": False}, {"name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu", "order": 3, "visible": False}, {"name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure", "order": 8, "visible": True}, {"name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks", "order": 1, "visible": True}, {"name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough", "order": 6, "visible": False}, {"name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard", "order": 3, "visible": False}, {"name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact", "order": 1, "visible": True}, {"name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque", "order": 1, "visible": False}, {"name": "darkGreenCharacteristic", "family": "colourFamily", "real_name": "dark green", "order": 10, "visible": True}, {"name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous", "order": 1, "visible": True}, {"name": "normalWidthCharacteristic", "family": "widthFamily", "real_name": "medium", "order": 2, "visible": True}, {"name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic", "order": 2, "visible": False}, {"name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte", "order": 10, "visible": False}, {"name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal", "order": 1, "visible": False}, {"name": "normalThicknessCharacteristic", "family": "thicknessFamily", "real_name": "medium", "order": 2, "visible": True}, {"name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating", "order": 12, "visible": False}, {"name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products", "order": 2, "visible": False}], "subcharacteristics": [{"name": "cpBrochantite", "real_name": "Brochantite Cu4(OH)6SO4"}, {"name": "cpCuSOH", "real_name": "S, O, H"}], "interfaces": {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata1_interface1", "characteristics": [{"name": "nonAdherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}]}, "children": [], "containers": {"cpCompositionAdditionalElements": [{"date": "2018-02-09", "phase": "Solid", "number": 14, "symbol": "Si", "name": "Si", "category": "metalloid", "version": 4, "real_name": "Silicon"}], "cpCompositionCompounds": [{"date": "2018-02-09", "name": "cpdBrochantite", "version": 4, "real_name": "Brochantite (Cu4(OH)6SO4)"}], "cpCompositionMainElements": [{"date": "2018-02-09", "phase": "Solid", "number": 29, "symbol": "Cu", "name": "Cu", "category": "transition metal", "version": 4, "real_name": "Copper"}], "cpCompositionSecondaryElements": [{"date": "2018-02-09", "phase": "Solid", "number": 16, "symbol": "S", "name": "S", "category": "polyatomic nonmetal", "version": 4, "real_name": "Sulfur"}, {"date": "2018-02-09", "phase": "Gas", "symbol": "O", "number": 8, "name": "O", "category": "diatomic nonmetal", "version": 4, "real_name": "Oxygen"}, {"date": "2018-02-09", "phase": "Gas", "symbol": "H", "number": 1, "name": "H", "category": "diatomic nonmetal", "version": 4, "real_name": "Hydrogen"}]}}, {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata2", "characteristics": [{"name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu", "order": 3, "visible": False}, {"name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure", "order": 8, "visible": True}, {"name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks", "order": 1, "visible": True}, {"name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough", "order": 6, "visible": False}, {"name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard", "order": 3, "visible": False}, {"name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact", "order": 1, "visible": True}, {"name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque", "order": 1, "visible": False}, {"name": "darkRedCharacteristic", "family": "colourFamily", "real_name": "dark red", "order": 6, "visible": True}, {"name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous", "order": 1, "visible": True}, {"name": "normalWidthCharacteristic", "family": "widthFamily", "real_name": "medium", "order": 2, "visible": True}, {"name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic", "order": 2, "visible": False}, {"name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte", "order": 10, "visible": False}, {"name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal", "order": 1, "visible": False}, {"name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin", "order": 3, "visible": True}, {"name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating", "order": 12, "visible": False}, {"name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products", "order": 2, "visible": False}], "subcharacteristics": [{"name": "cpCuprite", "real_name": "Cuprite (Cu2O)"}, {"name": "cpCuO", "real_name": "O"}], "interfaces": {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata2_interface2", "characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}]}, "children": [], "containers": {"cpCompositionCompounds": [{"date": "2018-02-09", "name": "cpdCuprite", "version": 4, "real_name": "Cuprite (Cu2O)"}], "cpCompositionMainElements": [{"date": "2018-02-09", "phase": "Solid", "number": 29, "symbol": "Cu", "name": "Cu", "category": "transition metal", "version": 4, "real_name": "Copper"}], "cpCompositionSecondaryElements": [{"date": "2018-02-09", "phase": "Gas", "symbol": "O", "number": 8, "name": "O", "category": "diatomic nonmetal", "version": 4, "real_name": "Oxygen"}]}}, {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata3", "characteristics": [{"name": "grainLargeCharacteristic", "family": "mMicrostructureFamily", "real_name": "large grain", "order": 3, "visible": True}, {"name": "noCracksCharacteristic", "family": "crackingFamily", "real_name": "no crack", "order": 3, "visible": True}, {"name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough", "order": 6, "visible": False}, {"name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard", "order": 3, "visible": False}, {"name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact", "order": 1, "visible": True}, {"name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque", "order": 1, "visible": False}, {"name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous", "order": 1, "visible": True}, {"name": "normalWidthCharacteristic", "family": "widthFamily", "real_name": "medium", "order": 2, "visible": True}, {"name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic", "order": 2, "visible": False}, {"name": "metallicCharacteristic", "family": "brightnessFamily", "real_name": "metallic", "order": 1, "visible": False}, {"name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal", "order": 1, "visible": False}, {"name": "thickCharacteristic", "family": "thicknessFamily", "real_name": "thick", "order": 1, "visible": True}, {"name": "parallelepipedalCharacteristic", "family": "shapeFamily", "real_name": "parallelepipedal", "order": 16, "visible": False}, {"name": "pinkCharacteristic", "family": "colourFamily", "real_name": "pink", "order": 7, "visible": True}, {"name": "mCharacteristic", "family": "natureFamily", "real_name": "Metal", "order": 4, "visible": False}], "subcharacteristics": [{"name": "inclusionsGrainLarge", "real_name": "inclusions Grain Large"}, {"name": "twinLinesGrainLarge", "real_name": "twin Lines Grain Large"}], "interfaces": {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata3_interface3", "characteristics": [{"name": "looselyCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}]}, "children": [], "containers": {"mCompositionMainElements": [{"date": "2018-02-09", "phase": "Solid", "number": 29, "symbol": "Cu", "name": "Cu", "category": "transition metal", "version": 4, "real_name": "Copper"}], "mCompositionSecondaryElements": [{"date": "2018-02-09", "phase": "Solid", "number": 82, "symbol": "Pb", "name": "Pb", "category": "post-transition metal", "version": 4, "real_name": "Lead"}]}}]},

}
class MicorrService(TestCase):
    """ Test module for micorrservice API """

    def setUp(self):
        self.client = Client()

    def test_getstratigraphydetails(self):
        # get API response
        # response = self.client.get('/micorr/json/getstratigraphydetails/')
        # self.assertEqual(response.status_code, 404)
        # we don't do actual service test as no neo4j test db is setup on travis.ci for now
        for s_uid in STRATIGRAPHY_REFS:
            response = self.client.get('/micorr/json/getstratigraphydetails/{uid}'.format(uid=s_uid))
            self.assertEqual(response.status_code, 200)
            stratigraphy = response.json()
            self.assertTrue('strata' in stratigraphy)
            self.assertTrue('description' in stratigraphy)
            self.assertTrue(len(stratigraphy['strata'])>0)
            str_ref = json.dumps(STRATIGRAPHY_REFS[s_uid], sort_keys=True)
            str_test = json.dumps(stratigraphy, sort_keys=True)
            json_diff=jsondiff.diff(STRATIGRAPHY_REFS[s_uid], stratigraphy)
            # ddiff = DeepDiff(STRATIGRAPHY_REFS[s_uid], stratigraphy, ignore_order=True)
            # if ddiff:
            #     print("DeepDiff:\n",ddiff,"\n")
            if json_diff:
                print(('\n/micorr/json/getstratigraphydetails/{uid} =>\n{dump}\n'.format(uid=s_uid, dump=str_test)))
                print("jsondiff:\n", json_diff, "\n")
            self.assertFalse(json_diff)

            # self.assertEqual(str_ref, str_test)

