from copy import deepcopy

from django.contrib.auth import get_user_model
from django.test import TestCase, Client
import json, jsondiff
import logging

_logger = logging.getLogger(__name__)
#logging.disable(logging.NOTSET)
_logger.setLevel(logging.INFO)

# CAUTION these tests read and write neo4j database
# requires an initialized reference test graphdb
# do not run on production

# sample stratigraphy output references taken from micorr.org production backup: graphdb_20200430_154109.dump
STRATIGRAPHY_REFS = {
'67d11e72-2574-11e6-a316-000c29148083':json.loads('{"strata": [{"name": "67d11e72-2574-11e6-a316-000c29148083_Strata1", "characteristics": [{"visible": true, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": true, "order": 2, "name": "normalThicknessCharacteristic", "family": "thicknessFamily", "real_name": "medium"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": true, "order": 10, "name": "darkGreenCharacteristic", "family": "colourFamily", "real_name": "dark green"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": false, "order": 13, "name": "cpExtensionSi", "family": "cpCompositionExtensionFamily", "real_name": "Si"}], "interfaces": {"characteristics": [{"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "67d11e72-2574-11e6-a316-000c29148083_Strata1_interface1"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "polyatomic nonmetal", "symbol": "S", "number": 16, "real_name": "Sulfur", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "S"}, {"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}, {"category": "diatomic nonmetal", "symbol": "H", "number": 1, "real_name": "Hydrogen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "H"}], "cpCompositionAdditionalElements": [{"category": "metalloid", "name": "Si", "symbol": "Si", "number": 14, "real_name": "Silicon", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Brochantite (Cu4(OH)6SO4)", "version": 4, "name": "cpdBrochantite"}]}}, {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata2", "characteristics": [{"visible": true, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin"}, {"visible": true, "order": 6, "name": "darkRedCharacteristic", "family": "colourFamily", "real_name": "dark red"}, {"visible": true, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "67d11e72-2574-11e6-a316-000c29148083_Strata2_interface2"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}], "cpCompositionAdditionalElements": [{"category": "polyatomic nonmetal", "symbol": "S", "number": 16, "real_name": "Sulfur", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "S"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Cuprite (Cu2O)", "version": 4, "name": "cpdCuprite"}]}}, {"name": "67d11e72-2574-11e6-a316-000c29148083_Strata3", "characteristics": [{"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "metallicCharacteristic", "family": "brightnessFamily", "real_name": "metallic"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": true, "order": 1, "name": "thickCharacteristic", "family": "thicknessFamily", "real_name": "thick"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": true, "order": 3, "name": "grainLargeCharacteristic", "family": "mMicrostructureFamily", "real_name": "large grain"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "noCracksCharacteristic", "family": "crackingFamily", "real_name": "no crack"}, {"visible": false, "order": 4, "name": "mCharacteristic", "family": "natureFamily", "real_name": "Metal"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": true, "order": 7, "name": "pinkCharacteristic", "family": "colourFamily", "real_name": "pink"}, {"visible": false, "order": 16, "name": "parallelepipedalCharacteristic", "family": "shapeFamily", "real_name": "parallelepipedal"}], "interfaces": {"characteristics": [{"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "looselyCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "67d11e72-2574-11e6-a316-000c29148083_Strata3_interface3"}, "subcharacteristics": [{"name": "inclusionsGrainLarge", "real_name": "inclusions"}, {"name": "twinLinesGrainLarge", "real_name": "twin lines / Newmann bands"}], "children": [], "containers": {"mCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}]}}], "uid": "67d11e72-2574-11e6-a316-000c29148083", "description": "Shingle of a roof"}'),
'5e7030dc-25da-11e6-9e7f-000c29148083':json.loads('{"strata": [{"name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata1", "characteristics": [{"visible": true, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": true, "order": 2, "name": "normalThicknessCharacteristic", "family": "thicknessFamily", "real_name": "medium"}, {"visible": true, "order": 2, "name": "normalWidthCharacteristic", "family": "widthFamily", "real_name": "medium"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 4, "name": "discontinuous3Characteristic", "family": "continuityFamily", "real_name": "discontinuous3"}, {"visible": true, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": true, "order": 12, "name": "mediumBlueCharacteristic", "family": "colourFamily", "real_name": "medium blue"}, {"visible": false, "order": 13, "name": "cpExtensionSi", "family": "cpCompositionExtensionFamily", "real_name": "Si"}], "interfaces": {"characteristics": [{"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata1_interface1"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}, {"category": "diatomic nonmetal", "symbol": "H", "number": 1, "real_name": "Hydrogen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "H"}, {"category": "polyatomic nonmetal", "symbol": "C", "number": 6, "real_name": "Carbon", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "C"}], "cpCompositionAdditionalElements": [{"category": "metalloid", "name": "Si", "symbol": "Si", "number": 14, "real_name": "Silicon", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Malachite (Cu2CO3(OH)2)", "version": 4, "name": "cpdMalachite"}]}}, {"name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata2", "characteristics": [{"visible": true, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "porousCharacteristic", "family": "porosityFamily", "real_name": "porous"}, {"visible": true, "order": 3, "name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin"}, {"visible": true, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": false, "order": 14, "name": "cpExtensionSn", "family": "cpCompositionExtensionFamily", "real_name": "Sn"}, {"visible": true, "order": 16, "name": "blackCharacteristic", "family": "colourFamily", "real_name": "black"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata2_interface2"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}, {"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Tenorite (CuO)", "version": 4, "name": "cpdTenorite"}, {"date": "2018-02-09", "real_name": "Cuprite (Cu2O)", "version": 4, "name": "cpdCuprite"}, {"date": "2018-02-09", "real_name": "Cassiterite (SnO2)", "version": 4, "name": "cpdCassiterite"}]}}, {"name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata3", "characteristics": [{"visible": true, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin"}, {"visible": true, "order": 5, "name": "redCharacteristic", "family": "colourFamily", "real_name": "red"}, {"visible": true, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata3_interface3"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}, {"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}], "cpCompositionAdditionalElements": [{"category": "metalloid", "name": "Si", "symbol": "Si", "number": 14, "real_name": "Silicon", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Cuprite (Cu2O)", "version": 4, "name": "cpdCuprite"}]}}, {"name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata4", "characteristics": [{"visible": true, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin"}, {"visible": false, "order": 5, "name": "cpExtensionCl", "family": "cpCompositionExtensionFamily", "real_name": "Cl"}, {"visible": false, "order": 6, "name": "cpExtensionCu", "family": "cpCompositionExtensionFamily", "real_name": "Cu"}, {"visible": true, "order": 6, "name": "noMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "no microstructure"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": false, "order": 7, "name": "cpSnCharacteristic", "family": "cpCompositionFamily", "real_name": "Sn"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": true, "order": 14, "name": "brownCharacteristic", "family": "colourFamily", "real_name": "brown"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata4_interface4"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}, {"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}], "cpCompositionAdditionalElements": [{"category": "post-transition metal", "symbol": "Pb", "number": 82, "real_name": "Lead", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Pb"}, {"category": "metalloid", "name": "Si", "symbol": "Si", "number": 14, "real_name": "Silicon", "date": "2018-02-09", "version": 4, "phase": "Solid"}, {"category": "diatomic nonmetal", "symbol": "Cl", "number": 17, "real_name": "Chlorine", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "Cl"}]}}, {"name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata5", "characteristics": [{"visible": false, "order": 1, "name": "cmCharacteristic", "family": "natureFamily", "real_name": "Corroded metal"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": true, "order": 3, "name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": null, "order": null, "name": "r2Characteristic", "family": "cmCorrosionRatioFamily", "real_name": "r2"}], "interfaces": {"characteristics": [{"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata5_interface5"}, "subcharacteristics": [], "children": [{"characteristics": [{"name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata5_childCP"}, {"characteristics": [{"name": "mCharacteristic", "family": "natureFamily", "real_name": "Metal"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata5_childM"}], "containers": {}}, {"name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata6", "characteristics": [{"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "metallicCharacteristic", "family": "brightnessFamily", "real_name": "metallic"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": true, "order": 1, "name": "thickCharacteristic", "family": "thicknessFamily", "real_name": "thick"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": true, "order": 3, "name": "grainLargeCharacteristic", "family": "mMicrostructureFamily", "real_name": "large grain"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "noCracksCharacteristic", "family": "crackingFamily", "real_name": "no crack"}, {"visible": true, "order": 3, "name": "porousCharacteristic", "family": "porosityFamily", "real_name": "porous"}, {"visible": false, "order": 4, "name": "mCharacteristic", "family": "natureFamily", "real_name": "Metal"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": true, "order": 7, "name": "pinkCharacteristic", "family": "colourFamily", "real_name": "pink"}, {"visible": false, "order": 16, "name": "parallelepipedalCharacteristic", "family": "shapeFamily", "real_name": "parallelepipedal"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "straightCharacteristic", "family": "interfaceProfileFamily"}], "name": "5e7030dc-25da-11e6-9e7f-000c29148083_Strata6_interface6"}, "subcharacteristics": [{"name": "eutecticPhaseGrainLarge", "real_name": "eutectic phase"}, {"name": "inclusionsGrainLarge", "real_name": "inclusions"}, {"name": "slipLinesGrainLarge", "real_name": "slip lines"}, {"name": "twinLinesGrainLarge", "real_name": "twin lines / Newmann bands"}], "children": [], "containers": {"mCompositionSecondaryElements": [{"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}], "mCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}]}}], "uid": "5e7030dc-25da-11e6-9e7f-000c29148083", "description": "Bed structure"}'),
'c6afc0ce-2579-11e6-a9ce-000c29148083':json.loads('{"strata": [{"secondaryComponents": [{"characteristics": [{"visible": false, "order": 1, "name": "cpExtensionAg", "family": "cpCompositionExtensionFamily", "real_name": "Ag"}, {"visible": false, "order": 1, "name": "cpAgCharacteristic", "family": "cpCompositionFamily", "real_name": "Ag"}], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Ag", "symbol": "Ag", "number": 47, "real_name": "Silver", "date": "2018-02-09", "version": 4, "phase": "Solid"}, {"category": "transition metal", "name": "Fe", "symbol": "Fe", "number": 26, "real_name": "Iron", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}, {"category": "post-transition metal", "symbol": "Pb", "number": 82, "real_name": "Lead", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Pb"}, {"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}]}, "subCharacteristics": []}], "name": "c6afc0ce-2579-11e6-a9ce-000c29148083_Strata1", "characteristics": [{"visible": true, "order": 1, "name": "branchedCracksCharacteristic", "family": "crackingFamily", "real_name": "branched cracks"}, {"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": true, "order": 2, "name": "normalThicknessCharacteristic", "family": "thicknessFamily", "real_name": "medium"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 4, "name": "isolatedAggregateMicrostructureCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "isolated aggregate microstructure"}, {"visible": false, "order": 6, "name": "cpExtensionCu", "family": "cpCompositionExtensionFamily", "real_name": "Cu"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": false, "order": 7, "name": "cpExtensionFe", "family": "cpCompositionExtensionFamily", "real_name": "Fe"}, {"visible": false, "order": 7, "name": "cpSnCharacteristic", "family": "cpCompositionFamily", "real_name": "Sn"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": false, "order": 13, "name": "cpExtensionSi", "family": "cpCompositionExtensionFamily", "real_name": "Si"}, {"visible": true, "order": 15, "name": "greyCharacteristic", "family": "colourFamily", "real_name": "grey"}], "interfaces": {"characteristics": [{"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "c6afc0ce-2579-11e6-a9ce-000c29148083_Strata1_interface1"}, "subcharacteristics": [], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Fe", "symbol": "Fe", "number": 26, "real_name": "Iron", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}, {"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}], "cpCompositionAdditionalElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}, {"category": "metalloid", "name": "Si", "symbol": "Si", "number": 14, "real_name": "Silicon", "date": "2018-02-09", "version": 4, "phase": "Solid"}, {"category": "post-transition metal", "symbol": "Pb", "number": 82, "real_name": "Lead", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Pb"}]}}, {"secondaryComponents": [{"characteristics": [{"visible": false, "order": 1, "name": "cpExtensionAg", "family": "cpCompositionExtensionFamily", "real_name": "Ag"}, {"visible": false, "order": 1, "name": "cpAgCharacteristic", "family": "cpCompositionFamily", "real_name": "Ag"}], "containers": {}, "subCharacteristics": []}], "name": "c6afc0ce-2579-11e6-a9ce-000c29148083_Strata2", "characteristics": [{"visible": true, "order": 1, "name": "compactCharacteristic", "family": "porosityFamily", "real_name": "compact"}, {"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 2, "name": "cpCharacteristic", "family": "natureFamily", "real_name": "Corrosion products"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": false, "order": 3, "name": "cpCuCharacteristic", "family": "cpCompositionFamily", "real_name": "Cu"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "noCracksCharacteristic", "family": "crackingFamily", "real_name": "no crack"}, {"visible": true, "order": 3, "name": "thinCharacteristic", "family": "thicknessFamily", "real_name": "thin"}, {"visible": true, "order": 4, "name": "orangeCharacteristic", "family": "colourFamily", "real_name": "orange"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": true, "order": 7, "name": "pseudomorphOfDendriticCharacteristic", "family": "cpriMicrostructureFamily", "real_name": "pseudomorph of dendritic microstructure"}, {"visible": false, "order": 10, "name": "matteCharacteristic", "family": "brightnessFamily", "real_name": "matte"}, {"visible": false, "order": 12, "name": "layerFilmCoatingCharacteristic", "family": "shapeFamily", "real_name": "layer/film/coating"}, {"visible": false, "order": 14, "name": "cpExtensionSn", "family": "cpCompositionExtensionFamily", "real_name": "Sn"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "c6afc0ce-2579-11e6-a9ce-000c29148083_Strata2_interface2"}, "subcharacteristics": [{"name": "eutecticPhasePseudomorphOfDendriticCpri", "real_name": "eutectic phase"}, {"name": "inclusionsPseudomorphOfDendriticCpri", "real_name": "inclusions"}], "children": [], "containers": {"cpCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}], "cpCompositionSecondaryElements": [{"category": "diatomic nonmetal", "symbol": "O", "number": 8, "real_name": "Oxygen", "date": "2018-02-09", "version": 4, "phase": "Gas", "name": "O"}], "cpCompositionAdditionalElements": [{"category": "transition metal", "name": "Fe", "symbol": "Fe", "number": 26, "real_name": "Iron", "date": "2018-02-09", "version": 4, "phase": "Solid"}, {"category": "post-transition metal", "symbol": "Pb", "number": 82, "real_name": "Lead", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Pb"}, {"category": "metalloid", "name": "Si", "symbol": "Si", "number": 14, "real_name": "Silicon", "date": "2018-02-09", "version": 4, "phase": "Solid"}, {"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}], "cpCompositionCompounds": [{"date": "2018-02-09", "real_name": "Cuprite (Cu2O)", "version": 4, "name": "cpdCuprite"}]}}, {"name": "c6afc0ce-2579-11e6-a9ce-000c29148083_Strata3", "characteristics": [{"visible": true, "order": 1, "name": "continuousCharacteristic", "family": "continuityFamily", "real_name": "continuous"}, {"visible": true, "order": 1, "name": "dendriticCharacteristic", "family": "mMicrostructureFamily", "real_name": "dendrites"}, {"visible": true, "order": 1, "name": "largeCharacteristic", "family": "widthFamily", "real_name": "large"}, {"visible": false, "order": 1, "name": "longitudinalCharacteristic", "family": "directionFamily", "real_name": "longitudinal"}, {"visible": false, "order": 1, "name": "metallicCharacteristic", "family": "brightnessFamily", "real_name": "metallic"}, {"visible": false, "order": 1, "name": "opaqueCharacteristic", "family": "opacityFamily", "real_name": "opaque"}, {"visible": false, "order": 1, "name": "ringShapedCharacteristic", "family": "shapeFamily", "real_name": "circular"}, {"visible": true, "order": 1, "name": "thickCharacteristic", "family": "thicknessFamily", "real_name": "thick"}, {"visible": false, "order": 2, "name": "notMagneticCharacteristic", "family": "magnetismFamily", "real_name": "non magnetic"}, {"visible": true, "order": 2, "name": "slightlyPorousCharacteristic", "family": "porosityFamily", "real_name": "slightly porous"}, {"visible": false, "order": 3, "name": "hardCharacteristic", "family": "hardnessFamily", "real_name": "hard"}, {"visible": true, "order": 3, "name": "noCracksCharacteristic", "family": "crackingFamily", "real_name": "no crack"}, {"visible": false, "order": 4, "name": "mCharacteristic", "family": "natureFamily", "real_name": "Metal"}, {"visible": false, "order": 6, "name": "toughCharacteristic", "family": "cohesionFamily", "real_name": "tough"}, {"visible": true, "order": 7, "name": "pinkCharacteristic", "family": "colourFamily", "real_name": "pink"}], "interfaces": {"characteristics": [{"name": "adherentCharacteristic", "family": "interfaceAdherenceFamily"}, {"name": "irregularCharacteristic", "family": "interfaceProfileFamily"}, {"name": "roughCharacteristic", "family": "interfaceRoughnessFamily"}, {"name": "sharpCharacteristic", "family": "interfaceTransitionFamily"}], "name": "c6afc0ce-2579-11e6-a9ce-000c29148083_Strata3_interface3"}, "subcharacteristics": [{"name": "eutecticPhaseDendritic", "real_name": "eutectic phase"}, {"name": "inclusionsDendritic", "real_name": "inclusions"}], "children": [], "containers": {"mCompositionSecondaryElements": [{"category": "post-transition metal", "symbol": "Sn", "number": 50, "real_name": "Tin", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Sn"}, {"category": "post-transition metal", "symbol": "Pb", "number": 82, "real_name": "Lead", "date": "2018-02-09", "version": 4, "phase": "Solid", "name": "Pb"}], "mCompositionMainElements": [{"category": "transition metal", "name": "Cu", "symbol": "Cu", "number": 29, "real_name": "Copper", "date": "2018-02-09", "version": 4, "phase": "Solid"}]}}], "uid": "c6afc0ce-2579-11e6-a9ce-000c29148083", "description": "Bracelet with a dense, black lake patina"}')
}

class MicorrService(TestCase):
    """ Test module for micorrservice API """

    @classmethod
    def make_user(cls, username='testuser', password='password', perms=None):
        """
        Build a user with <username> and password of 'password' for testing
        purposes.
        """
        User = get_user_model()

        test_user = User.objects.create_user(
                username,
                '{0}@example.com'.format(username),
                password,
                id=2 # micorr user id owner of test
            )
        return test_user

    def setUp(self):
        self.client = Client()
        self.user = self.make_user()

    def test_getstratigraphydetails(self):
        # get API response
        # response = self.client.get('/micorr/json/getstratigraphydetails/')
        # self.assertEqual(response.status_code, 404)
        # we don't do actual service test as no neo4j test db is setup on travis.ci for now
        for s_uid in STRATIGRAPHY_REFS:
            _logger.info('loading {}'.format(s_uid))
            response = self.client.get('/micorr/json/getstratigraphydetails/{uid}'.format(uid=s_uid))
            self.assertEqual(response.status_code, 200)
            stratigraphy = response.json()
            self.assertTrue('strata' in stratigraphy)
            self.assertTrue('description' in stratigraphy)
            self.assertTrue(len(stratigraphy['strata']) > 0)
            json_diff = jsondiff.diff(STRATIGRAPHY_REFS[s_uid], stratigraphy)
            if json_diff:
                _logger.error(
                    "/micorr/json/getstratigraphydetails/{uid} =>\ndata={data}\n".format(uid=s_uid, data=stratigraphy))
            self.assertFalse(json_diff)

    def test_save(self):
        self.client.force_login(self.user)
        for s_uid in STRATIGRAPHY_REFS:
            _logger.info('saving {}'.format(s_uid))
            # accounting here our legacy load/save format difference
            # todo fix this
            strata = []
            for stratum in STRATIGRAPHY_REFS[s_uid]['strata']:
                save_format_stratum = deepcopy(stratum)
                # subcharacteristics key on load vs subCharacteristics on save...
                save_format_stratum['subCharacteristics'] = save_format_stratum.pop('subcharacteristics')
                save_format_stratum['interfaces'] = stratum['interfaces']['characteristics']
                strata.append(save_format_stratum)
                if 'secondaryComponents' not in save_format_stratum:
                    save_format_stratum['secondaryComponents'] = []
                if 'children' in save_format_stratum:
                    # only characteristics are in children strata returned by getstratigraphydetails
                    # save expects empty list/dict (see strata.js:toJson)
                    for child in save_format_stratum['children']:
                        child['subCharacteristics'] = child.get('subCharacteristics', [])
                        child['interfaces'] = child.get('interfaces', [])
                        child['children'] = child.get('children', [])
                        child['secondaryComponents'] = child.get('secondaryComponents', [])
                        child['containers'] = child.get('containers', {})

            save_response = self.client.post('/micorr/json/save', json.dumps(
                {'artefact': 'ignored', 'stratigraphy': s_uid, 'stratas': strata}),
                                             content_type='application/json')
            self.assertEqual(save_response.status_code, 200)
            # self.assertEqual(save_response.status_code, 403,'when saving as anonymous user')

            _logger.info('reloading {}'.format(s_uid))
            reload_response = self.client.get('/micorr/json/getstratigraphydetails/{uid}'.format(uid=s_uid))
            self.assertEqual(reload_response.status_code, 200)

            stratigraphy = reload_response.json()
            json_diff = jsondiff.diff(STRATIGRAPHY_REFS[s_uid], stratigraphy)
            self.assertFalse(json_diff)
